# https://taskfile.dev

version: '3'


tasks:
  setup:
    desc: "Install dependencies"
    cmds:
      - uv sync --extra dev --inexact --quiet

  default:
    desc: "Run all checks: `task`"
    deps: [ typecheck, lint, test ]

  format:
    desc: "Format"
    cmds:
      - uv run --inexact --extra lint ruff format src tests

  lint:
    desc: "Lint"
    deps: [ format ]
    cmds:
      - uv run --inexact --extra lint ruff check src tests --fix

  clear:
    desc: "Clear __pycache__"
    cmds:
      - rm -rf ./**/*/__pycache__
      - rm -rf ./**/__pycache__
      - rm -rf ./__pycache__
    silent: true

  typecheck:
    desc: "Typecheck"
    env:
      MYPYPATH: src
    cmds:
      - uv sync --inexact --quiet --extra typecheck
      - uv run --no-sync zuban check src tests
      - uv run --no-sync mypy src tests
      - uv run --no-sync pyright src tests


  test:
    desc: "Run tests"
    deps: [ clear ]
    cmds:
      - uv sync --inexact --quiet --extra test
      - uv run --no-sync  coverage run --data-file .coverage --source src -m pytest
      - uv run --no-sync coverage combine --append .coverage.pytest-cov .coverage
      - uv run --no-sync coverage report
    env:
      PYTHONDONTWRITEBYTECODE: 1

  htmlcov:
    desc: "Run tests and open htmlcov in browser"
    deps: [ test ]
    cmds:
      - uv run --inexact --extra test coverage html
      - open htmlcov/index.html

  add:
    desc: "Add optional dependency: `task add -- test pytest-cov`"
    cmds:
      - uv add --optional {{ .CLI_ARGS }}

  remove:
    desc: "Add optional dependency: `task add -- test pytest-cov`"
    cmds:
      - uv remove --optional {{.CLI_ARGS}}

  sync:
    cmds:
      - uv sync $(for arg in {{.CLI_ARGS}}; do echo --extra $arg; done)